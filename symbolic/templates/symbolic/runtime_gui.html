<!DOCTYPE html>
<html>
<head>
    <title>Runtime Symbolic Control Analysis</title>

    <!-- ================= MathJax ================= -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- ================= Mermaid ================= -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>

    <style>
        body {
            font-family: Segoe UI, Arial, sans-serif;
            background: #d9d9d9;
        }
        .container {
            width: 900px;
            margin: 20px auto;
            background: #ececec;
            padding: 15px;
            border: 1px solid #aaa;
        }
        h2 { margin-top: 0; }
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 15px;
        }
        .panel {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #bbb;
        }
        label {
            display: block;
            margin-top: 8px;
            font-weight: 600;
        }
        input, select, textarea {
            width: 100%;
            margin-top: 4px;
            padding: 4px;
            font-size: 14px;
        }
        textarea { resize: vertical; }
        .buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 6px 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .output {
            background: white;
            height: 120px;
        }
        .equations {
            background: #fff;
            height: 90px;
            font-family: Consolas, monospace;
        }
        .bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        pre {
            background: #fff;
            padding: 10px;
            border: 1px solid #bbb;
            white-space: pre-wrap;
        }
        .latex-box {
            background: #ffffff;
            padding: 10px;
            border: 1px solid #bbb;
            margin-top: 10px;
        }
        .diagram-box {
            background: #ffffff;
            padding: 10px;
            border: 1px solid #bbb;
            margin-top: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
<div class="container">
<h2>Runtime Symbolic Control-System Analysis</h2>

<form method="post">
{% csrf_token %}

<div class="grid">

<!-- LEFT PANEL -->
<div class="panel">
    <label>Number of symbolic variables</label>
    <input type="number" id="num_vars" name="num_vars"
           value="{{ num_vars|default:3 }}" min="1">

    <label>Number of forward gains</label>
    <input type="number" id="num_forward" name="num_forward"
           value="{{ num_forward|default:2 }}" min="0">

    <label>Number of backward gains</label>
    <input type="number" id="num_backward" name="num_backward"
           value="{{ num_backward|default:2 }}" min="0">

    <div class="buttons">
        <button type="submit" name="action" value="tf">TF</button>
        <button type="submit" name="action" value="block">Block Diagram</button>
        <button type="submit" name="action" value="laplace">ℒ</button>
        <button type="submit" name="action" value="inv_laplace">ℒ⁻¹</button>
    </div>
</div>

<!-- RIGHT PANEL -->
<div class="panel">
    <label>Generated symbols</label>
    <textarea id="symbols_out"
              class="output"
              readonly></textarea>

    <label>
        System of symbolic equations
        <span style="font-weight:normal;">(one expression per line, implicit = 0)</span>
    </label>
    <textarea name="equations"
              class="equations"
    >{{ equations|default:'' }}</textarea>

    <label>Forward gain G(s)</label>
    <input type="text" name="forward_gain"
           value="{{ forward_gain|default:'' }}">

    <label>Backward gain H(s)</label>
    <input type="text" name="backward_gain"
           value="{{ backward_gain|default:'' }}">
</div>

</div>

<div class="buttons" style="margin-top:15px;">
<button type="submit">Compute</button>
</div>

</form>

<!-- ================= TEXT RESULT ================= -->
{% if result %}
<h3>Result</h3>
<pre>{{ result }}</pre>
{% endif %}

{% if error %}
<h3 style="color:red;">Error</h3>
<pre>{{ error }}</pre>
{% endif %}

<!-- ================= LaTeX OUTPUT ================= -->
{% if latex_equations %}
<h3>System of Equations</h3>
<div class="latex-box">
{% for eq in latex_equations %}
$$ {{ eq }} $$
{% endfor %}
</div>
{% endif %}

{% if latex_tf %}
<h3>Overall Transfer Function</h3>
<div class="latex-box">
$$ {{ latex_tf }} $$
</div>
{% endif %}

<!-- ================= BLOCK DIAGRAM OUTPUT ================= -->
{% if mermaid %}
<h3>Block Diagram (Structural)</h3>
<div class="diagram-box">
<pre class="mermaid">
{{ mermaid }}
</pre>
</div>
{% endif %}

</div>

<!-- ================= JavaScript ================= -->
<script>
function gen(prefix, n) {
    if (isNaN(n) || n < 1) return "";
    let a = [];
    for (let i = 1; i <= n; i++) a.push(prefix + i);
    return a.join(", ");
}

function updateAll() {
    const nv = parseInt(document.getElementById("num_vars").value);
    const nf = parseInt(document.getElementById("num_forward").value);
    const nb = parseInt(document.getElementById("num_backward").value);

    const xs = gen("x", nv);
    const gs = gen("G", nf);
    const hs = gen("H", nb);

    let text = "";
    if (xs) text += "Symbolic variables:\n" + xs + "\n\n";
    if (gs) text += "Forward gains:\n" + gs + "\n\n";
    if (hs) text += "Backward gains:\n" + hs;

    document.getElementById("symbols_out").value = text.trim();
}

["num_vars", "num_forward", "num_backward"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("change", updateAll);
});

window.addEventListener("load", updateAll);
</script>

</body>
</html>
